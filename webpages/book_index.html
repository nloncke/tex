{% extends "base_topsearch.html" %}
{% block header %}
<script type="text/javascript" src="/static/jquery.countdown.js"></script>
{% endblock header %}
{% block content %}
{% if book %}
{% block confirmation %}
{% endblock confirmation %}

<!-- DISPLAY THE BOOK -->
<div class="media">
	<img class="media-object pull-left" src="{{ book.frontcover }}" alt="{{ book.title }}" height="211px" width="171px">
	<div class="media-body book-info">
		<h3 class="media-heading header"><strong>{{book.title}}</strong></h3>
    	<h2 class="subheader">
         	<p>Author(s): {{book.author}}</p>
         	<p>ISBN-13: {{book.isbn}}</p>
         	<p>Published Date: {{book.pub_date}}</p>
    	<!-- button should submit book's isbn and change URL -->
    	<a href="/sell/?isbn={{book.isbn}}"><button type="submit" class="btn btn-default blue_button">
			<span><strong>SELL</strong></span>
      	</button></a>
      	{% if is_follow %}   	
	        <button type="submit" id="unfollow" form="unfollow_book" class="btn btn-default blue_button"
	        	onclick="document.getElementById('unfollow_book').submit(); return false;">
	        	<span><strong>UNFOLLOW</strong></span>
	        </button>     
        {% else %}
      	<button type="submit" id="follow" class="btn btn-default blue_button"
      		onclick="document.getElementById('follow_book').submit(); return false;">
        	<span><strong>FOLLOW</strong></span>
        </button>

        {% endif %}
    	</h2>
  	</div>
</div>
<form id="unfollow_book" action="/book/" method="post"> {% csrf_token %}
	<input type="hidden" id="target_isbn" name="target_isbn" value="{{book.isbn}}"/>
	<input type="hidden" id="book_action" name="book_action" value="unfollow">
</form>
<form id="follow_book" action="/book/" method="post"> {% csrf_token %}
	<input type="hidden" id="target_isbn" name="target_isbn" value="{{book.isbn}}"/>
    <input type="hidden" id="book_action" name="book_action" value="follow">
</form>
<!-- AUCTION TABLE -->
<div class="media">
	<div class="media-body">
    	<h3 class="media-heading header"><br><strong>Auctions</strong></h3>
    	{% if auctions %}
    	<h2 class="subheader">
	    	<table class="table table-borderless table-responsive" width="80%">
	     		<th></th>
	     		<th>Last Bid</th>
	     		<th>Time Left</th>
	     		<th>Condition</th>
	     		<th>Description</th>

	         	{% for auction in auctions %}
	         	<tr class="countdown_{{auction.auction_id}}">
          		<!-- button should only trigger modal -->
	   				<td><button id="auction_{{auction.auction_id}}" data-toggle="modal" data-target="#auction_modal_{{auction.auction_id}}"
	        			class="btn btn-default blue_button"><span><strong>BID</strong></span></button>
	  				</td>
          		<!-- end trigger button -->
         			<td >${{ auction.current_price }}</td>
              	    <td><div class="actualcountdown_{{auction.auction_id}}"></div></td>
	         		<td>{{ auction.condition }}</td>
	         		<td>{{ auction.description }}</td>

         		</tr>
         	<script type="text/javascript">
				$(function() {
				    $('.actualcountdown_{{auction.auction_id}}').countdown({
				        date: "{{auction.end_time}}",
					    onEnd: function() {
					    	return $(".countdown_{{auction.auction_id}}").hide();
					    }
				    });
				});
				$(function() {
				    $('.modalcountdown_{{auction.auction_id}}').countdown({
				        date: "{{auction.end_time}}",
					    onEnd: function() {
					    	$("#bid_{{auction.auction_id}}").attr("disabled", "disabled");
					    	$("#buy_now_{{auction.auction_id}}").attr("disabled", "disabled");
					    	return;
					    }
				    });
				});
			</script>

	         	  <!-- modal to prompt bidder. if they bid, confirmation is displayed with new modal. -->
            <!-- end of auction prompt modal -->
            <div class="modal fade" id="auction_modal_{{auction.auction_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			 			</div>
				  		<div class="modal-body">
				    		<div class="modal-bid">
				    			 <img class="media-object pull-left" src="{{ book.frontcover }}" alt="{{ book.title }}" height="158px" width="128px">
								 <div class="media-body book-info">
								     <h3 class="media-heading header"><strong>{{book.title}}</strong></h3>
								     <h2 class="subheader">
								     	<p>Author(s): {{book.author}}</p>
								     	<p>ISBN-13: {{book.isbn}}</p>
								     	<p>Published Date: {{book.pub_date}}</p>
								     </h2>
								</div>
				    			<h2><strong>Time Left</strong></h2>
				    			<div class="modalcountdown_{{auction.auction_id}}"><input id="expired_auction_{{auction.auction_id}}"></div>
				    			<h2><strong>Current Bid</strong></h2>
				    			<form id="bid_submit_{{auction.auction_id}}" action="/buy/bid/" method="post"> {% csrf_token %}
				    				<h3>${{auction.current_price}}  + <input id="bid" name="bid" type="number" style="width:50px" value="1" pattern="(^[1-9]$)|(^[1-9]\d$)"
				    					title="You have bid higher than the buy now price. You can buy the book or bid less.">
				    				<button type="submit" id="bid_{{auction.auction_id}}" class="btn btn-default blue_button" form="bid_submit_{{auction.auction_id}}">BID</button></h3>
				    				<input id="auction_id" name="auction_id" type="hidden" value="{{auction.auction_id}}">
				    				<input id="current_price" name="current_price" type="hidden" value="{{auction.current_price}}">
				    				<input id="buy_now_price" name="buy_now_price" type="hidden" value="{{auction.buy_now_price}}">
				    			</form>
				    			<h2><strong>Buy Now Price</strong></h2>
				    			<form id="buy_now_submit_{{auction.auction_id}}" action="/buy/confirm/" method="post">{% csrf_token %}
				    				<h3>${{auction.buy_now_price}}
				    				<button type="submit" id="buy_now_{{auction.auction_id}}" class="btn btn-default blue_button" form="buy_now_submit_{{auction.auction_id}}">BUY</button></h3>
				    				<input id="auction_id" name="auction_id" type="hidden" value="{{auction.auction_id}}">
				    				<input id="is_auction" name="is_auction" type="hidden" value="true">
				    			</form>
				    		</div>
				 		</div>
					</div>
				</div>
			</div>
			{% endfor %}
          	</table>
          	{% else %}
	     	<h3 style="font-size:22px">Sorry, there are currently no auctions.</h3>
		</h2>
	</div>
</div>
{% endif %}
<!-- OFFERS TABLE -->
<div class="media">
	<div class="media-body">
    	<h3 class="media-heading header"><br><strong>Offers</strong></h3>
    	{% if offers %}
    	<h1 style="font-size:18px">
         	<p>Check out these sites for more prices:
         		{% if book.labyrinth %}<a href={{book.labyrinth}} target="_blank">Labyrinth </a>{% endif %}
         		{% if book.amazon %}<a href={{book.amazon}} target="_blank">Amazon </a>{% endif %}
         		{% if book.chegg %}<a href={{book.chegg}} target="_blank">Chegg </a>{% endif %}
         		{% if book.campus %}<a href={{book.campus}} target="_blank">Campus </a>{% endif %}
         	</p>
     	</h1>
        <h2 class="subheader">
        	<table class="table table-borderless" width="80%">
	     		<th></th>
	     		<th>Price</th>
	     		<th>Condition</th>
	     		<th>Description</th>
	         	<tr>
 	         	{% for offer in offers %}
              	<!-- button should only trigger modal -->
	           		<td><button id="buy_{{offer.offer_id}}" data-toggle="modal" data-target="#buy_modal_{{offer.offer_id}}"class="btn btn-default blue_button">
	                    <span><strong>BUY</strong></span>
	                   	</button>
             		</td>
              	<!-- end trigger button -->

              <td>${{ offer.buy_price }}</td>
	         		<td>{{ offer.condition }}</td>
	         		<td>{{ offer.description }}</td>
	         	</tr>
 	        <!-- modal to prompt buyer. if they buy, confirmation is displayed with new modal. -->
            <div class="modal fade" id="buy_modal_{{offer.offer_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
              <div class="modal-dialog">
              	<div class="modal-content">
              		<div class="modal-header">
              			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                 	</div>
                  <div id="buy_modal_body" class="modal-body">
                    Are you sure you want to purchase {{ book.title }} for
                    ${{ offer.buy_price }}? If you confirm we'll put you in contact with the seller.
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default translucent_button" data-dismiss="modal">No</button>
                    <button type="submit" data-dismiss="modal"
                    	onclick="document.getElementById('buy_form_{{offer.offer_id}}').submit(); $('#buy_modal_{{offer.offer_id}}').modal('hide'); return false;" class="btn btn-default blue_button">Yes</button>
                    <!-- hidden form to check if offer still there -->
                    <form id="buy_form_{{offer.offer_id}}" name="buy_form" action="/buy/confirm/" method="post"> {% csrf_token %}
                      <input type="hidden" id="buyer_id" name="buyer_id" value="{{ user }}"/>
                      <input type="hidden" id="offer_id" name="offer_id" value="{{ offer.offer_id }}"/>
                    </form>
                    <!-- end of hidden form -->
                  </div>
                </div>
              </div>
            </div>
            <!-- end of buyer's prompt modal -->



             <!-- follow confirmation modal
            <div class="modal fade" id="confirm_follow_modal" tabindex="-1" role="dialog"
            	aria-labelledby="confirmModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="confirmModalLabel">You are now following this book!</h4>
                  </div>
                  <div id="confirm_modal_body" class="modal-body">
                  	Thanks for following "{{ book.title }}"! You can edit your follow list on your account page.
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Okay
                    	</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- end of follow confirmation modal -->

          {% endfor %}
	         </table>
	     {% else %}
	     <h3 style="font-size:22px">Sorry, there are currently no offers.</h3>
	     <h3 class="subheader">Check out these sites instead:
         		{% if book.labyrinth %}<a href={{book.labyrinth}} target="_blank">Labyrinth </a>{% endif %}
         		{% if book.amazon %}<a href={{book.amazon}} target="_blank">Amazon </a>{% endif %}
         		{% if book.chegg %}<a href={{book.chegg}} target="_blank">Chegg </a>{% endif %}
         		{% if book.campus %}<a href={{book.campus}} target="_blank">Campus </a>{% endif %}
       	 </h3>
      </h2>
   </div>
</div>
{% endif %}

{% endif %}
{% endblock content %}

